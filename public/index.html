<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Canvas App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.47/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app" class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Camera Canvas App</h1>
        <div class="mb-4">
            <video ref="video" class="w-full max-w-md mx-auto" autoplay></video>
        </div>
        <div class="mb-4">
            <button @click="capturePhoto" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Capture Photo
            </button>
        </div>
        <div class="mb-4">
            <canvas ref="canvas" class="w-full max-w-md mx-auto border border-gray-300"></canvas>
        </div>
        <div>
            <button @click="sendToAPI" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Send to API
            </button>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const video = ref(null);
                const canvas = ref(null);
                let stream = null;

                onMounted(async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        video.value.srcObject = stream;
                    } catch (err) {
                        console.error("Error accessing camera:", err);
                    }
                });

                const capturePhoto = () => {
                    const context = canvas.value.getContext('2d');
                    canvas.value.width = video.value.videoWidth;
                    canvas.value.height = video.value.videoHeight;
                    context.drawImage(video.value, 0, 0, canvas.value.width, canvas.value.height);
                };

                const sendToAPI = async () => {
                    // Convert canvas to blob
                    const blob = await new Promise(resolve => canvas.value.toBlob(resolve, 'image/jpeg'));
                    try {
                        const response = await fetch('/api/print', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'image/jpeg',
                            },
                            body: blob,
                        });
                        if (response.ok) {
                            alert('Image sent successfully!');
                        } else {
                            throw new Error('Failed to send image');
                        }
                    } catch (err) {
                        console.error("Error sending image to API:", err);
                        alert('Failed to send image to API');
                    }
                };

                return {
                    video,
                    canvas,
                    capturePhoto,
                    sendToAPI,
                };
            },
        }).mount('#app');
    </script>
</body>
</html>